<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Model</title>
    <style>
        /* This removes all borders and scrollbars */
        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: none;
            /* HIDE THE DEFAULT CURSOR */
        }

        canvas {
            display: block;
        }

        #custom-cursor {
            position: fixed;
            left: 0;
            top: 0;
            width: 100px;
            height: 150px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 9999;
            display: none;
            /* Hide by default */
        }

        /* --- NEW: MOBILE PERMISSION OVERLAY --- */
        #permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        #permission-button {
            font-size: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            background: white;
            color: black;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-weight: 500;
        }
    </style>
</head>

<body>
    <!-- NEW: MOBILE PERMISSION OVERLAY -->
    <div id="permission-overlay">
        <button id="permission-button">Tap to Start</button>
    </div>

    <!-- CUSTOM CURSOR IMAGE -->
    <img id="custom-cursor" src="water.png">

    <!-- 
      This is an "importmap". It tells the browser where to find
      the Three.js library files from a fast CDN.
    -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.166.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.166.1/examples/jsm/"
        }
    }
    </script>

    <!-- This is the main 3D script -->
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';

        // --- 1. CONFIGURATION ---
        const MODEL_URL = "Gkmodel4.glb";

        const HEAD_BONE_NAME = "Head";
        const SPINE_BONE_NAME = "Spine2";

        const MAX_YAW_ANGLE = 30;    // Max degrees left/right
        const MAX_PITCH_ANGLE = 20;  // Max degrees up/down
        const SMOOTHING = 0.05;

        const SPINE_YAW_INFLUENCE = 0.3;
        const SPINE_PITCH_INFLUENCE = 0.5;

        const MODEL_SCALE = 1.8;
        const MODEL_POS_Y = -1.3;

        const CAMERA_TRANSITION_DURATION = 2.5;
        const START_CAM_X = 0, START_CAM_Y = 1.3, START_CAM_Z = 1.5;
        const END_CAM_X = 0, END_CAM_Y = 1.4, END_CAM_Z = 2.5;

        // --- NEW: GYRO SENSITIVITY ---
        // How many degrees you must tilt phone for full head turn
        const GYRO_SENSITIVITY_RANGE = 25.0;
        // ---------------------------------------------

        let scene, camera, renderer, headBone, spineBone, mixer, clock, cursorImage;
        let mousePos = new THREE.Vector2();

        // --- NEW: Device Control Variables ---
        const isMobile = /Mobi|Android|iPhone/i.test(navigator.userAgent);
        let initialBeta = null;
        let initialGamma = null;

        let transitionTimer = 0.0;
        const startCamPos = new THREE.Vector3(START_CAM_X, START_CAM_Y, START_CAM_Z);
        const endCamPos = new THREE.Vector3(END_CAM_X, END_CAM_Y, END_CAM_Z);

        // 1. Setup the Scene
        scene = new THREE.Scene();
        clock = new THREE.Clock();
        camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.copy(startCamPos);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        // Find cursor image
        cursorImage = document.getElementById('custom-cursor');

        // 2. Add Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);

        // 3. Load the Model
        const dracoLoader = new DRACOLoader();
        dracoLoader.setDecoderPath('https://unpkg.com/three@0.166.1/examples/jsm/libs/draco/gltf/');
        const loader = new GLTFLoader();
        loader.setDRACOLoader(dracoLoader);

        loader.load(MODEL_URL, (gltf) => {
            gltf.scene.scale.set(MODEL_SCALE, MODEL_SCALE, MODEL_SCALE);
            gltf.scene.position.set(0, MODEL_POS_Y, 0);
            scene.add(gltf.scene);

            headBone = gltf.scene.getObjectByName(HEAD_BONE_NAME);
            spineBone = gltf.scene.getObjectByName(SPINE_BONE_NAME);
            if (!headBone) console.error(`Error: Could not find bone named "${HEAD_BONE_NAME}"`);
            if (!spineBone) console.warn(`Warning: Could not find bone named "${SPINE_BONE_NAME}"`);

            if (gltf.animations.length > 0) {
                mixer = new THREE.AnimationMixer(gltf.scene);
                const action = mixer.clipAction(gltf.animations[0]);
                action.play();
            } else {
                console.warn("Model has no animations to play.");
            }
        }, undefined, (error) => console.error(error));


        // 4. --- NEW: Setup Device-Specific Controls ---

        // This function handles GYRO input
        function onDeviceMove(event) {
            if (event.beta === null || event.gamma === null) return;

            // Set the "zero" point on the first move
            if (initialBeta === null) {
                initialBeta = event.beta;
                initialGamma = event.gamma;
            }

            // Calculate the *change* from the zero point
            const deltaBeta = event.beta - initialBeta;  // Tilting fwd/back
            const deltaGamma = event.gamma - initialGamma; // Tilting left/right

            // --- Map gyro delta to mousePos (from -1 to 1) ---

            // Map tilt left/right (gamma) to mouse X
            // Clamp value between -1 and 1
            mousePos.x = THREE.MathUtils.clamp(
                deltaGamma / GYRO_SENSITIVITY_RANGE,
                -1, 1
            );

            // Map tilt fwd/back (beta) to mouse Y
            // We invert beta to match the mouse "up = look up" logic
            mousePos.y = THREE.MathUtils.clamp(
                -deltaBeta / GYRO_SENSITIVITY_RANGE,
                -1, 1
            );
        }

        // This function handles MOUSE input
        function onMouseMove(event) {
            // For 3D Look-At
            mousePos.x = (event.clientX / window.innerWidth) * 2 - 1;
            mousePos.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // For Custom PNG Cursor
            if (cursorImage) {
                cursorImage.style.display = 'block'; // Show the cursor
                cursorImage.style.left = `${event.clientX}px`;
                cursorImage.style.top = `${event.clientY}px`;
            }
        }

        // This function requests permission on mobile
        function startExperience() {
            const overlay = document.getElementById('permission-overlay');
            overlay.style.display = 'none'; // Hide the button

            // --- iOS 13+ requires this permission request ---
            if (typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function') {

                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', onDeviceMove);
                        } else {
                            console.warn('Gyro permission not granted.');
                        }
                    })
                    .catch(console.error);
            } else {
                // For Android or older iOS, just add the listener
                window.addEventListener('deviceorientation', onDeviceMove);
            }
        }

        // --- This is the main startup logic ---
        if (isMobile) {
            // On mobile, show the "Tap to Start" button
            const overlay = document.getElementById('permission-overlay');
            const startButton = document.getElementById('permission-button');
            overlay.style.display = 'flex';
            startButton.addEventListener('click', startExperience);
        } else {
            // On desktop, just start the mouse listener
            window.addEventListener('mousemove', onMouseMove);
        }

        // 5. The Render Loop (runs every frame)
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            // Camera Transition
            if (transitionTimer < CAMERA_TRANSITION_DURATION) {
                transitionTimer += delta;
                let progress = Math.min(transitionTimer / CAMERA_TRANSITION_DURATION, 1.0);
                let easedProgress = progress < 0.5
                    ? 4 * progress * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;
                camera.position.lerpVectors(startCamPos, endCamPos, easedProgress);
            }

            // Head/Spine Rotation (this code is unchanged, it just reads mousePos)
            const targetYaw = mousePos.x * THREE.MathUtils.degToRad(MAX_YAW_ANGLE);
            const targetPitch = -mousePos.y * THREE.MathUtils.degToRad(MAX_PITCH_ANGLE);

            if (headBone) {
                headBone.rotation.y = THREE.MathUtils.lerp(headBone.rotation.y, targetYaw, SMOOTHING);
                headBone.rotation.x = THREE.MathUtils.lerp(headBone.rotation.x, targetPitch, SMOOTHING);
            }
            if (spineBone) {
                spineBone.rotation.y = THREE.MathUtils.lerp(spineBone.rotation.y, targetYaw * SPINE_YAW_INFLUENCE, SMOOTHING);
                spineBone.rotation.x = THREE.MathUtils.lerp(spineBone.rotation.x, targetPitch * SPINE_PITCH_INFLUENCE, SMOOTHING);
            }

            // Animation Mixer
            if (mixer) {
                mixer.update(delta);
            }

            renderer.render(scene, camera);
        }

        // Handle window resizing
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        window.addEventListener('resize', onWindowResize);

        // Start the loop!
        animate();
    </script>
</body>

</html>