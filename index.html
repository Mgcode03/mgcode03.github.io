<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR Image Tracking Demo</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            user-select: none;
            overflow: hidden;
            /* Prevent scrolling */
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        /* Container for the Three.js canvas */
        #ar-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* UI Overlay for the button and messages */
        #ui-overlay {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            max-width: 90%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>

    <!-- Load Three.js modules via import map (using a modern version) -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
            }
        }
    </script>
</head>

<body>

    <!-- Main container for the Three.js view -->
    <div id="ar-container"></div>

    <!-- UI Overlay for the AR Button and status messages -->
    <div id="ui-overlay" class="p-4 bg-white/90 backdrop-blur-sm rounded-xl shadow-2xl border border-gray-100">
        <p class="text-sm font-semibold text-indigo-600 mb-3 text-center">TARGET IMAGE:</p>
        <!-- Sample target image for the user to scan -->
        <img id="target-image"
            src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"
            alt="Target image to scan"
            class="w-32 h-32 rounded-lg border-2 border-indigo-300 shadow-md mb-4 object-contain">

        <!-- The ARButton will replace this placeholder button -->
        <button id="ar-button"
            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full transition duration-150 shadow-lg active:scale-95">
            Initializing WebXR...
        </button>
        <p id="status-message" class="mt-3 text-center text-sm text-gray-700 font-medium w-full"></p>
    </div>

    <script type="module">
        import * as THREE from 'three';
        // Import ARButton helper from Three.js examples
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        // --- Configuration Constants ---
        const TARGET_IMAGE_URL = "https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png";
        const REAL_WORLD_IMAGE_WIDTH_M = 0.08; // Estimated width of the physical card in meters (8cm)

        const AR_CONTAINER = document.getElementById('ar-container');
        const statusMessage = document.getElementById('status-message');
        const arButtonElement = document.getElementById('ar-button');

        let renderer, scene, camera;
        let referenceSpace;
        let cube, arContainer;

        /**
         * Utility function to display messages on the UI.
         */
        function displayMessage(message) {
            statusMessage.textContent = message;
        }

        /**
         * Converts a Blob (from fetch) into an ImageBitmap.
         */
        function createImageBitmap(blob) {
            return window.createImageBitmap(blob);
        }

        /**
         * Initializes Three.js scene, camera, and renderer.
         */
        function initScene() {
            // 1. Scene and Camera Setup
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // 2. Renderer Setup
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            AR_CONTAINER.appendChild(renderer.domElement);

            // 3. Lighting
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            scene.add(light);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.7);
            directionalLight.position.set(1, 2, 1);
            scene.add(directionalLight);

            // 4. AR Content (Cube) Setup
            // This group holds the 3D object and will be positioned/rotated by the tracking data
            arContainer = new THREE.Group();
            arContainer.visible = false;
            scene.add(arContainer);

            const geometry = new THREE.BoxGeometry(0.05, 0.05, 0.05); // 5cm cube
            const material = new THREE.MeshStandardMaterial({ color: 0x4ade80, metalness: 0.2, roughness: 0.5 });
            cube = new THREE.Mesh(geometry, material);
            cube.position.y = 0.025; // Lift cube half its height above the image plane
            arContainer.add(cube);

            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        /**
         * Loads the image, sets up ImageBitmap, and configures WebXR.
         */
        async function setupXR() {
            displayMessage("Loading target image for tracking...");

            let trackedImageBitmap;
            try {
                // Fetch the image and create ImageBitmap, which is required by the WebXR API
                const response = await fetch(TARGET_IMAGE_URL);
                const blob = await response.blob();
                trackedImageBitmap = await createImageBitmap(blob);

                displayMessage("Image loaded. Configuring WebXR...");
            } catch (e) {
                console.error("Failed to load image or create ImageBitmap:", e);
                displayMessage(`Error: Could not load target image. WebXR requires CORS-friendly image loading.`);
                return;
            }

            // Define the single tracked image for the WebXR session
            const trackedImages = [{
                image: trackedImageBitmap,
                widthInMeters: REAL_WORLD_IMAGE_WIDTH_M,
            }];

            // Options for AR session with Image Tracking feature
            const sessionInit = {
                requiredFeatures: ['local-floor', 'image-tracking'],
                trackedImages: trackedImages // Pass the image bitmap array
            };

            // Create the WebXR AR button, which handles feature support and session request
            const button = ARButton.createButton(renderer, sessionInit);

            // Replace the initial placeholder button with the functional ARButton
            arButtonElement.replaceWith(button);

            // Listen for session start to get the reference space and set the animation loop
            renderer.xr.addEventListener('sessionstart', (event) => {
                displayMessage("AR Session Started. Scan the target image now!");

                // Request the local-floor reference space
                event.session.requestReferenceSpace('local-floor').then(space => {
                    referenceSpace = space;
                });

                // Start the Three.js render loop
                renderer.setAnimationLoop(render);
            });

            renderer.xr.addEventListener('sessionend', () => {
                displayMessage("AR Session Ended. Tap the button to start again.");
                arContainer.visible = false;
            });

            // Update status based on ARButton's current text (usually for "NOT SUPPORTED")
            if (button.textContent.includes("NOT SUPPORTED")) {
                displayMessage("WebXR Image Tracking is NOT SUPPORTED on this browser/device.");
            }
        }

        /**
         * Main WebXR render loop.
         */
        function render(time, frame) {
            if (!frame || !referenceSpace) {
                // Render the scene without XR updates if not in an AR session or setup is incomplete
                renderer.render(scene, camera);
                return;
            }

            // 1. Get Image Tracking Results from the current frame
            // This returns an array of XRImageTrackingResult objects for tracked images
            const results = frame.getImageTrackingResults();

            if (results.length > 0) {
                const result = results[0]; // We are only tracking one image (index 0)

                // 2. Get the Pose (position and orientation) of the tracked image space
                const pose = frame.getPose(result.imageSpace, referenceSpace);

                if (pose) {
                    const trackingState = result.trackingState;

                    // 3. Apply the pose to the 3D container
                    arContainer.position.copy(pose.transform.position);
                    arContainer.rotation.setFromQuaternion(pose.transform.orientation);
                    arContainer.visible = true;

                    // 4. Cube Animation
                    cube.rotation.x += 0.01;
                    cube.rotation.y += 0.02;

                    // 5. Update Status Message
                    displayMessage(`Target Found! State: ${trackingState}. Spinning cube activated.`);

                } else {
                    // Pose is null (tracking lost momentarily or image is partially obscured)
                    arContainer.visible = false;
                    displayMessage("Target lost or out of view. Please find the image.");
                }
            } else {
                // No images currently tracked in the camera view
                arContainer.visible = false;
                displayMessage("Looking for target image...");
            }

            renderer.render(scene, camera);
        }

        // --- Initialization ---
        window.onload = function () {
            initScene();
            setupXR();
        };
    </script>

</body>

</html>
