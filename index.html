<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js WebXR AR Cube</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            user-select: none;
            overflow: hidden;
            /* Prevent scrolling */
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Style the canvas to take up the full viewport */
        #ar-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        /* UI Overlay for the button and messages */
        #ui-overlay {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
        }
    </style>
</head>

<body>

    <!-- Canvas will be initialized by Three.js -->
    <canvas id="ar-canvas"></canvas>

    <!-- UI Overlay for the AR Button and status messages -->
    <div id="ui-overlay" class="p-4 bg-white/80 backdrop-blur-sm rounded-xl shadow-2xl">
        <button id="ar-button"
            class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-full transition duration-150 shadow-lg">
            Start AR
        </button>
        <p id="status-message" class="mt-3 text-center text-sm text-gray-700"></p>
    </div>

    <script>
        // Check for WebXR compatibility and initialize the application
        window.onload = function () {
            if ('xr' in navigator) {
                checkWebXRSupport();
            } else {
                displayMessage("WebXR not supported in this browser.");
            }
        };

        let scene, camera, renderer, xrSession, xrReferenceSpace;
        let cube, cubeContainer;
        const arButton = document.getElementById('ar-button');
        const statusMessage = document.getElementById('status-message');

        /**
         * Checks if the device supports immersive AR and updates the button state.
         */
        async function checkWebXRSupport() {
            try {
                // Check if 'immersive-ar' session is supported
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    arButton.disabled = false;
                    arButton.onclick = startARSession;
                    displayMessage("Ready for AR. Tap the button!");
                } else {
                    displayMessage("AR mode not supported by your device or browser.");
                    arButton.disabled = true;
                }
            } catch (error) {
                console.error("WebXR check error:", error);
                displayMessage("Error checking AR support: " + error.message);
                arButton.disabled = true;
            }
        }

        /**
         * Initializes Three.js and requests the AR session.
         */
        async function startARSession() {
            arButton.disabled = true;
            arButton.textContent = 'Starting...';
            displayMessage("Requesting AR session...");

            try {
                // 1. Initialize Three.js Components
                initThree();

                // 2. Request the XR Session
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    // Request the 'local-floor' feature for stable placement
                    requiredFeatures: ['local-floor', 'viewer']
                });

                // 3. Configure Renderer for XR
                renderer.xr.setSession(xrSession);

                // 4. Set up Session Event Handlers
                xrSession.onend = onSessionEnded;

                // 5. Get Reference Space
                // 'local-floor' attempts to place the origin on the floor near the user.
                xrReferenceSpace = await xrSession.requestReferenceSpace('local-floor');

                // 6. Set up the Scene Content
                setupARContent();

                // 7. Start the AR Loop
                xrSession.requestAnimationFrame(renderLoop);

                arButton.style.display = 'none';
                displayMessage("AR Active! Look around and find the spinning cube.");

            } catch (error) {
                console.error("Failed to start AR session:", error);
                displayMessage("Error: AR session failed to start. " + error.message);
                arButton.disabled = false;
                arButton.textContent = 'Start AR';
            }
        }

        /**
         * Sets up the basic Three.js scene, renderer, and camera.
         */
        function initThree() {
            // Scene Setup
            scene = new THREE.Scene();

            // Renderer Setup
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true, // Crucial for AR to allow camera feed to show through
                canvas: document.getElementById('ar-canvas')
            });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.xr.enabled = true; // Enable XR for the renderer

            // Camera (The camera in AR is managed by the XR frame)
            camera = new THREE.PerspectiveCamera();
        }

        /**
         * Creates and places the 3D content in the scene.
         */
        function setupARContent() {
            // Container to hold the cube and manage its position relative to the origin
            cubeContainer = new THREE.Group();
            scene.add(cubeContainer);

            // Create a simple, spinning cube
            const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1); // 10cm cube
            const material = new THREE.MeshPhongMaterial({ color: 0x4ade80 });
            cube = new THREE.Mesh(geometry, material);

            // Set the cube's initial position relative to the local-floor origin
            // 1 meter in front of the origin and slightly above the floor.
            cube.position.set(0, 0.5, -1);
            cubeContainer.add(cube);

            // Add a light source so the cube is visible
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            scene.add(light);
        }

        /**
         * The main render loop for the XR session.
         */
        function renderLoop(time, frame) {
            // Request the next frame as soon as possible
            xrSession.requestAnimationFrame(renderLoop);

            if (!frame) return;

            // Get the pose of the viewer (headset or phone)
            const pose = frame.getViewerPose(xrReferenceSpace);

            if (pose) {
                // Update the camera based on the viewer's pose
                const xrCamera = pose.views[0].camera;
                if (xrCamera) {
                    camera.matrix.fromArray(xrCamera.matrix);
                    camera.projectionMatrix.fromArray(xrCamera.projectionMatrix);
                    camera.matrixWorldNeedsUpdate = true;
                }

                // Animate the cube
                cube.rotation.x = time * 0.001;
                cube.rotation.y = time * 0.002;

                // Render the scene
                renderer.render(scene, camera);
            }
        }

        /**
         * Handles the session end event.
         */
        function onSessionEnded() {
            xrSession = null;
            arButton.style.display = 'block';
            arButton.disabled = false;
            arButton.textContent = 'Start AR';
            displayMessage("AR Session ended. Tap to restart.");
            // Clean up Three.js components if necessary
        }

        /**
         * Utility function to display messages on the UI.
         */
        function displayMessage(message) {
            statusMessage.textContent = message;
        }

        /**
         * Handle window resizing
         */
        window.addEventListener('resize', () => {
            if (renderer) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>

</body>

</html>
