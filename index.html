<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World AR - Web Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #000;
        }
        #camera-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
            pointer-events: none; /* Let clicks pass through */
        }
        .header, .footer {
            width: 100%;
            padding: 2rem 1.5rem;
            pointer-events: auto; /* Re-enable pointer events for UI elements */
        }
        .header-content, .footer-content {
            max-width: 400px;
            margin: 0 auto;
            background-color: rgba(0,0,0,0.6);
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- Plane Visualizer --- */
        #plane-visualizer {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80vmin;
            height: 60vmin;
            transform-style: preserve-3d;
            transform: translate(-50%, -40%) rotateX(75deg);
            transition: opacity 0.5s ease;
            opacity: 0;
            pointer-events: none;
        }
        .grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(52, 152, 219, 0.5) 1px, transparent 1px),
                linear-gradient(90deg, rgba(52, 152, 219, 0.5) 1px, transparent 1px);
            background-size: 5vmin 5vmin;
            border: 1px solid rgba(52, 152, 219, 0.7);
            border-radius: 4px;
        }

        /* --- CUBE --- */
        .cube-container {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 80px;
            height: 80px;
            transform-style: preserve-3d;
            transform: translate(-50%, -50%);
            cursor: grab;
            pointer-events: auto; /* Make cube interactive */
        }
        .cube-container.selected .face{
             border-color: #3498db;
             box-shadow: 0 0 20px rgba(52, 152, 219, 0.8);
        }
        .cube {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(60deg) rotateY(0deg) rotateZ(0deg); /* Initial nice view */
        }
        .face {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid #2c3e50;
            background-color: rgba(236, 240, 241, 0.8);
        }
        .front  { transform: rotateY(  0deg) translateZ(40px); background-color: rgba(231, 76, 60, 0.85); }
        .back   { transform: rotateY(180deg) translateZ(40px); background-color: rgba(241, 196, 15, 0.85); }
        .right  { transform: rotateY( 90deg) translateZ(40px); background-color: rgba(46, 204, 113, 0.85); }
        .left   { transform: rotateY(-90deg) translateZ(40px); background-color: rgba(52, 152, 219, 0.85); }
        .top    { transform: rotateX( 90deg) translateZ(40px); background-color: rgba(155, 89, 182, 0.85); }
        .bottom { transform: rotateX(-90deg) translateZ(40px); background-color: rgba(26, 188, 156, 0.85); }
    </style>
</head>
<body class="bg-black text-white">

    <video id="camera-view" autoplay playsinline></video>
    
    <div id="ar-space" class="w-full h-full absolute top-0 left-0">
        <!-- Cubes will be added here -->
    </div>
    
    <div id="plane-visualizer">
        <div class="grid"></div>
    </div>

    <div class="overlay">
        <div class="header">
            <div class="header-content">
                <h1 class="text-xl font-bold">World AR (Web)</h1>
                <p id="status-text" class="text-sm mt-1 text-gray-300">Requesting camera access...</p>
            </div>
        </div>
        <div class="footer">
            <div id="footer-content" class="footer-content hidden">
                 <button id="remove-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Remove Selected Cube
                </button>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('camera-view');
        const arSpace = document.getElementById('ar-space');
        const statusText = document.getElementById('status-text');
        const planeVisualizer = document.getElementById('plane-visualizer');
        const removeButton = document.getElementById('remove-button');
        const footerContent = document.getElementById('footer-content');

        let isPlaneDetected = false;
        let placedObjects = [];
        let selectedObjectId = null;

        // --- Camera Setup ---
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                statusText.textContent = 'Scanning for a surface...';
                
                // Simulate plane detection
                setTimeout(() => {
                    isPlaneDetected = true;
                    if (placedObjects.length === 0) {
                        planeVisualizer.style.opacity = '1';
                    }
                    statusText.textContent = 'Surface detected. Tap to place a cube.';
                }, 2000);

            } catch (err) {
                console.error("Error accessing camera: ", err);
                statusText.textContent = 'Camera access denied. Please enable camera permissions.';
            }
        }
        
        // --- Object & Gesture Logic ---
        function createCube(id) {
            const cubeContainer = document.createElement('div');
            cubeContainer.className = 'cube-container';
            cubeContainer.id = `cube-${id}`;
            cubeContainer.dataset.id = id;

            const cube = document.createElement('div');
            cube.className = 'cube';
            
            const faces = ['front', 'back', 'right', 'left', 'top', 'bottom'];
            faces.forEach(faceName => {
                const face = document.createElement('div');
                face.className = `face ${faceName}`;
                cube.appendChild(face);
            });
            cubeContainer.appendChild(cube);
            arSpace.appendChild(cubeContainer);

            let state = {
                id,
                x: 0, y: 0,
                scale: 1,
                rotation: 0
            };
            
            addGestureControls(cubeContainer, state);
            
            return { id, element: cubeContainer, state };
        }
        
        function addGestureControls(element, state) {
            let initialPinchDistance = 0;
            let longPressTimeout;

            // Variables for drag
            let isDragging = false;
            let startX, startY;

            function getDistance(touches) {
                return Math.hypot(
                    touches[0].pageX - touches[1].pageX,
                    touches[0].pageY - touches[1].pageY
                );
            }

            function updateTransform() {
                element.style.transform = `translate(-50%, -50%) translate(${state.x}px, ${state.y}px)`;
                const cube = element.querySelector('.cube');
                cube.style.transform = `rotateX(60deg) rotateZ(${state.rotation}rad) scale(${state.scale})`;
            }

            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                selectObject(state.id);

                if (e.touches.length === 1) {
                    isDragging = true;
                    startX = e.touches[0].clientX - state.x;
                    startY = e.touches[0].clientY - state.y;
                    element.style.cursor = 'grabbing';
                } else if (e.touches.length === 2) {
                    isDragging = false;
                    initialPinchDistance = getDistance(e.touches);
                }
            });

            element.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (isDragging && e.touches.length === 1) {
                    state.x = e.touches[0].clientX - startX;
                    state.y = e.touches[0].clientY - startY;
                } else if (e.touches.length === 2) {
                    // Pinch to scale
                    const newDist = getDistance(e.touches);
                    state.scale = (state.scale * (newDist / initialPinchDistance));
                    initialPinchDistance = newDist;

                    // Two finger slide to rotate
                    const angle = Math.atan2(
                        e.touches[1].pageY - e.touches[0].pageY,
                        e.touches[1].pageX - e.touches[0].pageX
                    );
                    state.rotation = angle;
                }
                updateTransform();
            });

            element.addEventListener('touchend', (e) => {
                e.preventDefault();
                isDragging = false;
                element.style.cursor = 'grab';
            });
            
             // Mouse events for desktop testing
            element.addEventListener('mousedown', (e) => {
                e.preventDefault();
                selectObject(state.id);
                isDragging = true;
                startX = e.clientX - state.x;
                startY = e.clientY - state.y;
                element.style.cursor = 'grabbing';
            });
            
             window.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                state.x = e.clientX - startX;
                state.y = e.clientY - startY;
                updateTransform();
            });

            window.addEventListener('mouseup', (e) => {
                if (isDragging) {
                    isDragging = false;
                    element.style.cursor = 'grab';
                }
            });
        }
        
        function selectObject(id) {
            if (selectedObjectId === id) return;
            
            // Deselect previous
            if (selectedObjectId) {
                const oldSelected = document.getElementById(`cube-${selectedObjectId}`);
                if(oldSelected) oldSelected.classList.remove('selected');
            }
            
            // Select new
            selectedObjectId = id;
            const newSelected = document.getElementById(`cube-${id}`);
            if(newSelected) newSelected.classList.add('selected');

            footerContent.classList.remove('hidden');
        }

        function removeSelectedObject() {
            if (!selectedObjectId) return;

            const objectToRemove = placedObjects.find(obj => obj.id === selectedObjectId);
            if (objectToRemove) {
                arSpace.removeChild(objectToRemove.element);
                placedObjects = placedObjects.filter(obj => obj.id !== selectedObjectId);
                selectedObjectId = null;
                footerContent.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        arSpace.addEventListener('click', (e) => {
            // Only place if the direct target is ar-space (not a cube)
            if (e.target === arSpace && isPlaneDetected) {
                if (planeVisualizer.style.opacity === '1') {
                    planeVisualizer.style.opacity = '0';
                }
                const newId = Date.now();
                const newObject = createCube(newId);
                placedObjects.push(newObject);
                selectObject(newId);
            }
        });
        
        removeButton.addEventListener('click', removeSelectedObject);

        // --- Start ---
        window.addEventListener('load', setupCamera);
    </script>

</body>
</html>
